description "oFono Mobile telephony stack"

start on started dbus
stop on stopping dbus

pre-start script
	while [ ! -f /sys/class/modem-power/modem-power/device/powered_blocking ]; do sleep 1; done
	echo 1 > /sys/class/modem-power/modem-power/device/powered_blocking
	/usr/bin/enable-modem
end script

post-start script
	# Wait until the modem is found
	/usr/share/ofono/scripts/list-modems | grep -q "quectelqmi"
	while [ $? -ne 0 ]; do
		sleep 1
	/usr/share/ofono/scripts/list-modems | grep -q "quectelqmi"
	done

	sleep 2

	# Wait until the modem is enabled
	/usr/share/ofono/scripts/enable-modem | grep -q "quectelqmi"
	while [ $? -ne 0 ]; do
		sleep 1
		/usr/share/ofono/scripts/enable-modem
	done

	sleep 2
	/usr/share/ofono/scripts/online-modem
end script

expect fork
respawn

exec ofonod
